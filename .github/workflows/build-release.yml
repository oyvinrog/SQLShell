name: Build Release

on:
  release:
    types: [created]
  push:
    branches:
      - 'test-build/**'  # Trigger on branches like test-build/fix-icu
  workflow_dispatch:  # Allow manual trigger
    inputs:
      version:
        description: 'Version tag (e.g., v0.3.2)'
        required: false
        default: 'dev'

env:
  APP_NAME: SQLShell
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================
  # Publish to PyPI
  # ============================================
  publish-pypi:
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Required for trusted publishing
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Clean dist folder
        run: rm -rf dist/

      - name: Check if version already exists on PyPI
        run: |
          VERSION=$(grep -oP '^version = "\K[^"]+' pyproject.toml)
          echo "Checking if sqlshell==${VERSION} exists on PyPI..."
          
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://pypi.org/pypi/sqlshell/${VERSION}/json")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo ""
            echo "╔════════════════════════════════════════════════════════════════╗"
            echo "║  ⚠️  ERROR: Version ${VERSION} already exists on PyPI!          ║"
            echo "║                                                                ║"
            echo "║  PyPI versions are IMMUTABLE - you cannot overwrite them.     ║"
            echo "║                                                                ║"
            echo "║  To fix this:                                                  ║"
            echo "║  1. Update 'version' in pyproject.toml (e.g., to ${VERSION%.*}.$((${VERSION##*.}+1)))  ║"
            echo "║  2. Commit and push the change                                 ║"
            echo "║  3. Create a new release with the new version tag             ║"
            echo "╚════════════════════════════════════════════════════════════════╝"
            echo ""
            exit 1
          else
            echo "✓ Version ${VERSION} is available - proceeding with upload"
          fi

      - name: Update version in pyproject.toml
        if: github.event_name == 'release'
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix
          sed -i "s/^version = .*/version = \"${VERSION}\"/" pyproject.toml
          echo "Updated version to: ${VERSION}"
          grep "^version" pyproject.toml

      - name: Build package
        run: |
          echo "=== Building package ==="
          # Run from /tmp to avoid conflict with local build.py
          cd /tmp && python -m build $GITHUB_WORKSPACE --outdir $GITHUB_WORKSPACE/dist 2>&1 || { echo "Build failed!"; exit 1; }
          cd $GITHUB_WORKSPACE
          echo "=== Built packages ==="
          ls -la dist/
          echo "=== Package contents ==="
          ls dist/*.whl dist/*.tar.gz 2>/dev/null || echo "No packages found!"

      - name: Check package
        run: |
          if ls dist/*.whl 1> /dev/null 2>&1; then
            twine check dist/*.whl dist/*.tar.gz
          else
            echo "ERROR: No wheel files found in dist/"
            ls -la dist/
            exit 1
          fi

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          # For trusted publishing (recommended), no token needed
          # Just configure it on PyPI: https://docs.pypi.org/trusted-publishers/
          # 
          # OR use API token (set PYPI_API_TOKEN in repository secrets):
          # password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true
          verbose: true

  # ============================================
  # Build Platform Installers
  # ============================================
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug runner arch
        run: |
          echo "Runner OS: $RUNNER_OS"
          echo "Runner arch: $RUNNER_ARCH"
          uname -a

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Install Qt dependencies (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libxcb-xinerama0 \
            libxcb-cursor0 \
            libxkbcommon-x11-0 \
            libgl1-mesa-glx \
            libegl1 \
            libdbus-1-3 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxcb-shape0 \
            patchelf

      - name: Build executable
        run: python build.py
      
      - name: Run build verification
        run: python verify_build.py

      - name: Verify build includes critical modules
        run: |
          echo "=== Checking built distribution for critical modules ==="
          
          # Check that sqlshell/utils directory exists
          if [ ! -d "dist/SQLShell/_internal/sqlshell/utils" ]; then
            echo "ERROR: sqlshell/utils directory missing from build!"
            echo "Contents of dist/SQLShell/_internal/sqlshell/:"
            ls -la dist/SQLShell/_internal/sqlshell/ || echo "sqlshell directory not found"
            exit 1
          fi
          
          # Check for critical files
          CRITICAL_FILES=(
            "dist/SQLShell/_internal/sqlshell/utils/profile_column.py"
            "dist/SQLShell/_internal/sqlshell/utils/profile_cn2.py"
            "dist/SQLShell/_internal/sqlshell/utils/profile_ohe.py"
            "dist/SQLShell/_internal/sqlshell/utils/profile_entropy.py"
            "dist/SQLShell/_internal/sqlshell/db/database_manager.py"
            "dist/SQLShell/_internal/sqlshell/ui/filter_header.py"
          )
          
          MISSING=0
          for file in "${CRITICAL_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "ERROR: Missing critical file: $file"
              MISSING=1
            else
              echo "OK: $file"
            fi
          done
          
          if [ $MISSING -eq 1 ]; then
            echo ""
            echo "Build verification failed! Some critical modules are missing."
            echo "Check that sqlshell.spec includes all required directories in 'datas'."
            exit 1
          fi
          
          echo ""
          echo "=== Checking for ICU libraries ==="
          
          # Check for ICU libraries (required by Qt)
          ICU_COUNT=$(find dist/SQLShell -name "libicu*.so*" | wc -l)
          if [ "$ICU_COUNT" -eq 0 ]; then
            echo "ERROR: No ICU libraries found in build!"
            echo "Contents of dist/SQLShell:"
            ls -la dist/SQLShell/*.so* || echo "No .so files found"
            echo ""
            echo "This will cause the binary to fail with: 'libicudata.so.XX: cannot open shared object file'"
            exit 1
          else
            echo "Found $ICU_COUNT ICU libraries:"
            find dist/SQLShell -name "libicu*.so*" -exec basename {} \;
          fi
          
          echo ""
          echo "=== Build verification passed ==="

      - name: Create tarball
        run: |
          cd dist
          tar -czvf SQLShell-linux-x64.tar.gz SQLShell/

      - name: Install packaging tools
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev

      - name: Create .deb package
        env:
          RAW_VERSION: ${{ github.event.release.tag_name || github.event.inputs.version || '0.0.0' }}
        run: |
          # Get version and strip 'v' prefix
          VERSION="${RAW_VERSION#v}"
          echo "Building .deb with version: ${VERSION}"
          
          # Create directory structure
          mkdir -p deb-build/sqlshell/DEBIAN
          mkdir -p deb-build/sqlshell/opt/sqlshell
          mkdir -p deb-build/sqlshell/usr/bin
          mkdir -p deb-build/sqlshell/usr/share/applications
          mkdir -p deb-build/sqlshell/usr/share/icons/hicolor/256x256/apps
          
          # Copy application
          cp -r dist/SQLShell/* deb-build/sqlshell/opt/sqlshell/
          
          # Create launcher
          printf '#!/bin/bash\nexec /opt/sqlshell/SQLShell "$@"\n' > deb-build/sqlshell/usr/bin/sqlshell
          chmod +x deb-build/sqlshell/usr/bin/sqlshell
          
          # Create .desktop file
          printf '[Desktop Entry]\nType=Application\nName=SQLShell\nComment=A powerful SQL shell with GUI interface for data analysis\nExec=sqlshell\nIcon=sqlshell\nCategories=Development;Database;\nTerminal=false\n' > deb-build/sqlshell/usr/share/applications/sqlshell.desktop
          
          # Copy icon
          cp sqlshell/resources/icon.png deb-build/sqlshell/usr/share/icons/hicolor/256x256/apps/sqlshell.png || true
          
          # Calculate installed size
          SIZE=$(du -sk deb-build/sqlshell/opt | cut -f1)
          
          # Create control file (format is very strict - no leading spaces)
          printf 'Package: sqlshell\nVersion: %s\nSection: database\nPriority: optional\nArchitecture: amd64\nInstalled-Size: %s\nMaintainer: SQLShell Team\nDescription: A powerful SQL shell with GUI interface for data analysis\n SQLShell supports DuckDB, SQLite, CSV, Parquet, and Excel.\n' "${VERSION}" "${SIZE}" > deb-build/sqlshell/DEBIAN/control
          
          # Show control file for debugging
          echo "=== Control file ==="
          cat deb-build/sqlshell/DEBIAN/control
          echo "===================="
          
          # Build .deb
          dpkg-deb --build deb-build/sqlshell dist/sqlshell-linux-amd64.deb

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: |
            dist/SQLShell-linux-x64.tar.gz
            dist/sqlshell-linux-amd64.deb

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          architecture: 'x64'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller pillow

      - name: Create Windows icon
        run: |
          python -c "
          from PIL import Image
          import os
          # Try to use the highest quality source available
          icon_path = 'sqlshell/resources/icon.png'
          iconset_512 = 'sqlshell/resources/icon.iconset/icon_512x512.png'
          
          # Prefer 512x512 source if available, otherwise use icon.png
          if os.path.exists(iconset_512):
              img = Image.open(iconset_512)
              print(f'Using high-quality source: {iconset_512} ({img.size})')
          elif os.path.exists(icon_path):
              img = Image.open(icon_path)
              print(f'Using source: {icon_path} ({img.size})')
          else:
              print('Warning: No icon source found!')
              exit(1)
          
          # Ensure RGBA mode for best quality (add alpha channel if missing)
          if img.mode != 'RGBA':
              img = img.convert('RGBA')
              print(f'Converted to RGBA mode')
          
          # Create all required sizes with high-quality LANCZOS resampling
          sizes = [(16, 16), (32, 32), (48, 48), (64, 64), (128, 128), (256, 256)]
          icons = []
          for size in sizes:
              resized = img.resize(size, Image.Resampling.LANCZOS)
              icons.append(resized)
          
          # Save as ICO with all sizes - use the largest icon as base
          icons[-1].save('sqlshell/resources/icon.ico', format='ICO', sizes=sizes)
          print(f'Created icon.ico with {len(sizes)} sizes')
          "

      - name: Build executable
        run: |
          python -m PyInstaller --clean --noconfirm sqlshell.spec

      - name: Verify build includes critical modules
        run: |
          Write-Host "=== Checking built distribution for critical modules ===" -ForegroundColor Cyan
          
          # Check that sqlshell/utils directory exists
          if (-not (Test-Path "dist/SQLShell/_internal/sqlshell/utils")) {
            Write-Host "ERROR: sqlshell/utils directory missing from build!" -ForegroundColor Red
            Write-Host "Contents of dist/SQLShell/_internal/sqlshell/:"
            Get-ChildItem "dist/SQLShell/_internal/sqlshell/" -ErrorAction SilentlyContinue
            exit 1
          }
          
          # Check for critical files
          $criticalFiles = @(
            "dist/SQLShell/_internal/sqlshell/utils/profile_column.py",
            "dist/SQLShell/_internal/sqlshell/utils/profile_cn2.py",
            "dist/SQLShell/_internal/sqlshell/utils/profile_ohe.py",
            "dist/SQLShell/_internal/sqlshell/utils/profile_entropy.py",
            "dist/SQLShell/_internal/sqlshell/db/database_manager.py",
            "dist/SQLShell/_internal/sqlshell/ui/filter_header.py"
          )
          
          $missing = $false
          foreach ($file in $criticalFiles) {
            if (-not (Test-Path $file)) {
              Write-Host "ERROR: Missing critical file: $file" -ForegroundColor Red
              $missing = $true
            } else {
              Write-Host "OK: $file" -ForegroundColor Green
            }
          }
          
          if ($missing) {
            Write-Host ""
            Write-Host "Build verification failed! Some critical modules are missing." -ForegroundColor Red
            Write-Host "Check that sqlshell.spec includes all required directories in 'datas'."
            exit 1
          }
          
          Write-Host ""
          Write-Host "=== Build verification passed ===" -ForegroundColor Green

      - name: Install Inno Setup
        run: |
          choco install innosetup -y

      - name: Build installer
        run: |
          # Update version in .iss file
          $version = "${{ github.event.release.tag_name || github.event.inputs.version || '0.0.0' }}"
          $version = $version -replace '^v', ''
          (Get-Content installer/windows/sqlshell_inno.iss) -replace '#define MyAppVersion ".*"', "#define MyAppVersion `"$version`"" | Set-Content installer/windows/sqlshell_inno.iss
          
          # Compile installer
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer/windows/sqlshell_inno.iss

      - name: Rename installer with version
        run: |
          $version = "${{ github.event.release.tag_name || github.event.inputs.version || 'dev' }}"
          $version = $version -replace '^v', ''
          Move-Item -Path "dist/SQLShell-*-win64-setup.exe" -Destination "dist/SQLShell-$version-win64-setup.exe" -ErrorAction SilentlyContinue
          Get-ChildItem dist/*.exe

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: dist/*.exe

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install system dependencies
        run: |
          brew install libomp

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller pillow

      - name: Create macOS icon (.icns)
        run: |
          cd sqlshell/resources
          # Create iconset directory with all required sizes
          mkdir -p icon.iconset
          sips -z 16 16     icon.png --out icon.iconset/icon_16x16.png
          sips -z 32 32     icon.png --out icon.iconset/icon_16x16@2x.png
          sips -z 32 32     icon.png --out icon.iconset/icon_32x32.png
          sips -z 64 64     icon.png --out icon.iconset/icon_32x32@2x.png
          sips -z 128 128   icon.png --out icon.iconset/icon_128x128.png
          sips -z 256 256   icon.png --out icon.iconset/icon_128x128@2x.png
          sips -z 256 256   icon.png --out icon.iconset/icon_256x256.png
          sips -z 512 512   icon.png --out icon.iconset/icon_256x256@2x.png
          sips -z 512 512   icon.png --out icon.iconset/icon_512x512.png
          cp icon.png icon.iconset/icon_512x512@2x.png
          # Convert to .icns
          iconutil -c icns icon.iconset
          echo "Created icon.icns"
          ls -la icon.icns

      - name: Build executable
        run: python build.py

      - name: Verify build includes critical modules
        run: |
          echo "=== Checking built distribution for critical modules ==="
          
          # Check that sqlshell/utils directory exists
          if [ ! -d "dist/SQLShell/_internal/sqlshell/utils" ]; then
            echo "ERROR: sqlshell/utils directory missing from build!"
            echo "Contents of dist/SQLShell/_internal/sqlshell/:"
            ls -la dist/SQLShell/_internal/sqlshell/ || echo "sqlshell directory not found"
            exit 1
          fi
          
          # Check for critical files
          CRITICAL_FILES=(
            "dist/SQLShell/_internal/sqlshell/utils/profile_column.py"
            "dist/SQLShell/_internal/sqlshell/utils/profile_cn2.py"
            "dist/SQLShell/_internal/sqlshell/utils/profile_ohe.py"
            "dist/SQLShell/_internal/sqlshell/utils/profile_entropy.py"
            "dist/SQLShell/_internal/sqlshell/db/database_manager.py"
            "dist/SQLShell/_internal/sqlshell/ui/filter_header.py"
          )
          
          MISSING=0
          for file in "${CRITICAL_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "ERROR: Missing critical file: $file"
              MISSING=1
            else
              echo "OK: $file"
            fi
          done
          
          if [ $MISSING -eq 1 ]; then
            echo ""
            echo "Build verification failed! Some critical modules are missing."
            echo "Check that sqlshell.spec includes all required directories in 'datas'."
            exit 1
          fi
          
          echo ""
          echo "=== Build verification passed ==="

      - name: Create DMG
        run: |
          # Create a temporary directory for DMG contents
          mkdir -p dmg-contents
          cp -r dist/SQLShell dmg-contents/
          
          # Create DMG
          hdiutil create -volname "SQLShell" -srcfolder dmg-contents -ov -format UDZO dist/SQLShell-macos-arm64.dmg

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: dist/SQLShell-macos-arm64.dmg

  upload-release:
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Get version
        id: version
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Rename artifacts with version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Rename Linux artifacts
          mv artifacts/linux-build/SQLShell-linux-x64.tar.gz artifacts/SQLShell-${VERSION}-linux-x64.tar.gz || true
          mv artifacts/linux-build/sqlshell-linux-amd64.deb artifacts/sqlshell_${VERSION}_amd64.deb || true
          
          # Rename macOS artifact
          mv artifacts/macos-build/SQLShell-macos-arm64.dmg artifacts/SQLShell-${VERSION}-macos-arm64.dmg || true
          
          # Windows artifact (already versioned)
          mv artifacts/windows-build/*.exe artifacts/ || true
          
          ls -la artifacts/

      - name: Upload to release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/SQLShell-*.tar.gz
            artifacts/sqlshell_*.deb
            artifacts/SQLShell-*.dmg
            artifacts/SQLShell-*-setup.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
